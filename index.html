<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Soundboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tailwind gray-900 */
        }
        .sound-button {
            transition: all 0.2s ease-in-out;
        }
        .sound-button:active {
            transform: scale(0.95);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for the modal */
        #hotkey-settings-container::-webkit-scrollbar {
            width: 8px;
        }
        #hotkey-settings-container::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        #hotkey-settings-container::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        #hotkey-settings-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="text-white">

    <div class="w-full max-w-7xl mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight">Cloud Soundboard</h1>
            <p class="text-lg text-gray-400 mt-2">Your sounds, anywhere. Save your board and load it with a code.</p>
        </header>

        <main id="soundboard-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 min-h-[250px]">
            <!-- Sound controls are added by JavaScript -->
        </main>
        
        <footer class="text-center mt-10 flex flex-wrap justify-center gap-4">
            <button id="add-sound-button" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-5 rounded-lg transition-colors">
                Add Sound
            </button>
            <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-5 rounded-lg transition-colors">
                Save
            </button>
            <button id="load-button" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-5 rounded-lg transition-colors">
                Load
            </button>
            <button id="settings-button" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-5 rounded-lg transition-colors">
                Settings
            </button>
        </footer>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- FIREBASE SETUP ---
            let db;
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase initialization failed. Save/Load will not work.", error);
                showModal("Error", "Could not connect to the database. Save/Load features are disabled.");
            }

            // --- STATE ---
            let sounds = [];
            const colors = ['blue', 'indigo', 'purple', 'pink', 'red', 'orange', 'yellow', 'green', 'teal', 'cyan'];

            // --- DOM ELEMENTS ---
            const soundboardGrid = document.getElementById('soundboard-grid');
            const addSoundButton = document.getElementById('add-sound-button');
            const settingsButton = document.getElementById('settings-button');
            const saveButton = document.getElementById('save-button');
            const loadButton = document.getElementById('load-button');
            const modalContainer = document.getElementById('modal-container');

            // --- UTILITY & HELPER FUNCTIONS ---
            const showModal = (type, content) => {
                modalContainer.innerHTML = ''; // Clear previous modals
                let modalHTML = '';

                const baseModal = (title, body, footer) => `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" id="modal-backdrop">
                        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md m-4 p-8 flex flex-col">
                            <h2 class="text-3xl font-bold mb-6 text-center">${title}</h2>
                            <div class="flex-grow">${body}</div>
                            <div class="mt-8 flex justify-end items-center gap-4">${footer}</div>
                        </div>
                    </div>`;

                const closeModalButtonHTML = `<button class="modal-close bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg transition-colors">Close</button>`;

                switch (type) {
                    case 'settings':
                        modalHTML = baseModal('Settings', content, closeModalButtonHTML);
                        break;
                    case 'loading':
                         modalHTML = baseModal('Loading', `<div class="flex justify-center items-center"><div class="loader"></div><p class="ml-4">${content}</p></div>`, '');
                        break;
                    case 'save-code':
                        modalHTML = baseModal('Soundboard Code', `
                            <p class="text-center text-gray-300 mb-4">Save this code to load your soundboard anywhere!</p>
                            <div class="flex items-center bg-gray-900 p-3 rounded-lg">
                                <input id="soundboard-code-input" readonly value="${content}" class="flex-grow bg-transparent text-lg text-center font-mono focus:outline-none">
                                <button id="copy-code-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Copy</button>
                            </div>
                            <p id="copy-message" class="text-green-400 text-center h-5 mt-2"></p>`, closeModalButtonHTML);
                        break;
                     case 'load':
                        modalHTML = baseModal('Load Soundboard', `
                            <p class="text-center text-gray-300 mb-4">Enter your Soundboard Code below.</p>
                            <input id="load-code-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-center text-lg font-mono focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="Paste code here...">
                            <p id="load-error-message" class="text-red-400 text-center h-5 mt-2"></p>`,
                            `<button id="confirm-load-button" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-5 rounded-lg">Load</button>${closeModalButtonHTML}`);
                        break;
                    default: // Generic error/info
                        modalHTML = baseModal(type, `<p class="text-center text-gray-300">${content}</p>`, closeModalButtonHTML);
                        break;
                }
                modalContainer.innerHTML = modalHTML;
            };

            const closeModal = () => {
                modalContainer.innerHTML = '';
            };

            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                if (file.size > 1024 * 500) { // 500 KB limit per file
                   return reject(new Error(`File "${file.name}" is too large (> 500KB).`));
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({name: file.name, data: reader.result});
                reader.onerror = error => reject(error);
            });

            const base64toAudio = (base64String) => {
                const audio = new Audio(base64String);
                return audio;
            };

             const saveStateToLocalStorage = () => {
                try {
                    const stateToSave = sounds.map(s => ({
                        id: s.id,
                        hotkey: s.hotkey,
                        fileName: s.fileName,
                        audioData: s.audioData // Base64 string
                    }));
                    localStorage.setItem('soundboardState', JSON.stringify(stateToSave));
                } catch (e) {
                    console.error("Failed to save state to localStorage", e);
                }
            };

            // --- CORE SOUNDBOARD LOGIC ---

            const toggleSound = (id) => {
                const soundObj = sounds.find(s => s.id === id);
                if (!soundObj || !soundObj.audio) return;
                //... (rest of the function is the same as previous version)
                const button = soundObj.elements.playButton;
                if (soundObj.audio.paused) {
                    // Stop any other playing sounds
                    sounds.forEach(s => {
                        if (s.id !== id && s.audio && !s.audio.paused) {
                           toggleSound(s.id);
                        }
                    });
                    soundObj.audio.currentTime = 0;
                    soundObj.audio.play().catch(e => console.error("Error playing sound:", e));
                    button.textContent = 'Stop';
                    button.classList.remove(`bg-${soundObj.color}-600`, `hover:bg-${soundObj.color}-700`);
                    button.classList.add('bg-red-600', 'hover:bg-red-700');
                } else {
                    soundObj.audio.pause();
                    soundObj.audio.currentTime = 0;
                    button.textContent = `Play`;
                    button.classList.add(`bg-${soundObj.color}-600`, `hover:bg-${soundObj.color}-700`);
                    button.classList.remove('bg-red-600', 'hover:bg-red-700');
                }
            };

            const handleFileUpload = async (event, id) => {
                const soundObj = sounds.find(s => s.id === id);
                const file = event.target.files[0];
                if (!file || !soundObj) return;

                try {
                    const {name, data} = await fileToBase64(file);
                    soundObj.audioData = data;
                    soundObj.fileName = name;
                    soundObj.audio = base64toAudio(data);
                    
                    soundObj.elements.playButton.disabled = false;
                    soundObj.elements.fileName.textContent = name;
                    soundObj.elements.playButton.textContent = `Play`;

                    soundObj.audio.addEventListener('ended', () => {
                        const button = soundObj.elements.playButton;
                        button.textContent = `Play`;
                        button.classList.add(`bg-${soundObj.color}-600`, `hover:bg-${soundObj.color}-700`);
                        button.classList.remove('bg-red-600', 'hover:bg-red-700');
                    });
                    saveStateToLocalStorage();
                } catch (error) {
                    showModal("Upload Error", error.message);
                }
            };

            const addSoundControl = (data = null) => {
                const soundId = data ? data.id : sounds.length + 1;
                const color = colors[(soundId - 1) % colors.length];

                const soundControlHTML = `
                    <div id="sound-control-${soundId}" class="bg-gray-800 p-6 rounded-2xl shadow-lg flex flex-col items-center">
                        <h2 class="text-2xl font-semibold mb-4">Sound ${soundId}</h2>
                        <button id="play-button-${soundId}" class="sound-button w-full h-24 bg-${color}-600 hover:bg-${color}-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg text-xl font-bold flex items-center justify-center" disabled>
                            Upload a sound
                        </button>
                        <div class="w-full mt-4 text-center">
                            <label for="upload-${soundId}" class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg inline-block">
                                Upload Audio
                            </label>
                            <input type="file" id="upload-${soundId}" accept="audio/*" class="hidden">
                            <p id="file-name-${soundId}" class="text-sm text-gray-400 mt-2 truncate">No file selected</p>
                        </div>
                        <p class="mt-4 text-gray-300">Hotkey: <span id="hotkey-display-${soundId}" class="font-mono bg-gray-700 px-2 py-1 rounded">${soundId}</span></p>
                    </div>`;
                soundboardGrid.insertAdjacentHTML('beforeend', soundControlHTML);
                
                const newSoundObj = {
                    id: soundId,
                    audio: null,
                    audioData: null, // Base64 data
                    fileName: 'No file selected',
                    hotkey: String(soundId),
                    color: color,
                    elements: {
                        playButton: document.getElementById(`play-button-${soundId}`),
                        uploadInput: document.getElementById(`upload-${soundId}`),
                        fileName: document.getElementById(`file-name-${soundId}`),
                        hotkeyDisplay: document.getElementById(`hotkey-display-${soundId}`)
                    }
                };
                
                if (data) {
                    newSoundObj.hotkey = data.hotkey;
                    newSoundObj.fileName = data.fileName;
                    newSoundObj.audioData = data.audioData;
                    if(data.audioData) {
                         newSoundObj.audio = base64toAudio(data.audioData);
                         newSoundObj.elements.playButton.disabled = false;
                         newSoundObj.elements.playButton.textContent = `Play`;
                         newSoundObj.elements.fileName.textContent = data.fileName;
                         newSoundObj.audio.addEventListener('ended', () => {
                            const button = newSoundObj.elements.playButton;
                            button.textContent = `Play`;
                            button.classList.add(`bg-${newSoundObj.color}-600`, `hover:bg-${newSoundObj.color}-700`);
                            button.classList.remove('bg-red-600', 'hover:bg-red-700');
                        });
                    }
                    newSoundObj.elements.hotkeyDisplay.textContent = data.hotkey;
                }

                newSoundObj.elements.playButton.addEventListener('click', () => toggleSound(soundId));
                newSoundObj.elements.uploadInput.addEventListener('change', (e) => handleFileUpload(e, soundId));
                
                // Avoid duplicates when loading from state
                if (!sounds.some(s => s.id === soundId)) {
                    sounds.push(newSoundObj);
                }
            };

            const rebuildSoundboard = (soundData) => {
                soundboardGrid.innerHTML = '';
                sounds = [];
                soundData.forEach(addSoundControl);
                saveStateToLocalStorage();
            };

            // --- EVENT HANDLERS ---
            
            const saveSoundboardToCloud = async () => {
                if (!db) return showModal("Error", "Database connection is not available.");
                const soundData = sounds.map(s => ({
                    id: s.id,
                    hotkey: s.hotkey,
                    fileName: s.fileName,
                    audioData: s.audioData
                })).filter(s => s.audioData); // Only save boards with uploaded audio

                if (soundData.length === 0) {
                    return showModal("Cannot Save", "Please upload at least one audio file before saving.");
                }

                showModal('loading', 'Saving soundboard...');
                try {
                    const docRef = await addDoc(collection(db, "soundboards"), { data: soundData });
                    closeModal();
                    showModal('save-code', docRef.id);
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showModal("Error", "Could not save the soundboard to the cloud.");
                }
            };
            
            const loadSoundboardFromCloud = async (code) => {
                if (!db) return showModal("Error", "Database connection is not available.");
                if (!code || code.trim().length === 0) {
                     document.getElementById('load-error-message').textContent = 'Please enter a code.';
                    return;
                }

                showModal('loading', 'Loading soundboard...');
                try {
                    const docRef = doc(db, "soundboards", code.trim());
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const cloudData = docSnap.data().data;
                        rebuildSoundboard(cloudData);
                        closeModal();
                    } else {
                        closeModal();
                        showModal("Error", "No soundboard found with that code.");
                    }
                } catch (error) {
                     console.error("Error getting document:", error);
                     closeModal();
                     showModal("Error", "Could not load the soundboard.");
                }
            };
            
             // --- GLOBAL LISTENERS & INITIALIZATION ---
            
            modalContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-close') || e.target.id === 'modal-backdrop') {
                    closeModal();
                }
                if (e.target.id === 'copy-code-button') {
                    const codeInput = document.getElementById('soundboard-code-input');
                    navigator.clipboard.writeText(codeInput.value).then(() => {
                        document.getElementById('copy-message').textContent = 'Copied!';
                        setTimeout(() => {
                           const msgEl = document.getElementById('copy-message');
                           if(msgEl) msgEl.textContent = '';
                        }, 2000);
                    });
                }
                if (e.target.id === 'confirm-load-button') {
                    const codeInput = document.getElementById('load-code-input');
                    loadSoundboardFromCloud(codeInput.value);
                }
            });

            window.addEventListener('keydown', (e) => {
                 if (modalContainer.innerHTML !== '' || e.target.tagName === 'INPUT') {
                    return;
                }
                //... (rest of the function is the same as previous version)
                const key = e.key === ' ' ? 'Space' : e.key;
                const soundToPlay = sounds.find(s => s.hotkey === key);
                if (soundToPlay) {
                    e.preventDefault();
                    toggleSound(soundToPlay.id);
                    soundToPlay.elements.playButton.classList.add('scale-95');
                    setTimeout(() => soundToPlay.elements.playButton.classList.remove('scale-95'), 200);
                }
            });
            
            const init = () => {
                const savedState = localStorage.getItem('soundboardState');
                if (savedState) {
                    rebuildSoundboard(JSON.parse(savedState));
                } else {
                    addSoundControl();
                    addSoundControl();
                }

                addSoundButton.addEventListener('click', () => {
                    addSoundControl();
                    saveStateToLocalStorage();
                });
                saveButton.addEventListener('click', saveSoundboardToCloud);
                loadButton.addEventListener('click', () => showModal('load'));
                
                settingsButton.addEventListener('click', () => {
                    let settingsContent = '<div id="hotkey-settings-container" class="space-y-6 max-h-80 overflow-y-auto pr-2">';
                    sounds.forEach(soundObj => {
                       settingsContent += `
                        <div>
                            <label for="hotkey-input-${soundObj.id}" class="block text-sm font-medium text-gray-300 mb-2">Hotkey for Sound ${soundObj.id}</label>
                            <input type="text" id="hotkey-input-${soundObj.id}" data-id="${soundObj.id}" readonly
                                   class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-center text-lg font-mono cursor-pointer focus:ring-2 focus:ring-${soundObj.color}-500 focus:outline-none"
                                   value="${soundObj.hotkey}" placeholder="Press a key...">
                        </div>`;
                    });
                    settingsContent += '</div>';
                    showModal('settings', settingsContent);

                    // Re-attach listeners after modal is created
                    document.querySelectorAll('#hotkey-settings-container input').forEach(input => {
                        input.addEventListener('keydown', (e) => {
                            e.preventDefault();
                            const soundId = parseInt(e.target.dataset.id);
                            const soundObj = sounds.find(s => s.id === soundId);
                            if (soundObj) {
                                const key = e.key === ' ' ? 'Space' : e.key;
                                soundObj.hotkey = key;
                                e.target.value = key;
                                soundObj.elements.hotkeyDisplay.textContent = key;
                                saveStateToLocalStorage();
                            }
                        });
                    });
                });
            };
            
            init();
        });
    </script>

</body>
</html>

